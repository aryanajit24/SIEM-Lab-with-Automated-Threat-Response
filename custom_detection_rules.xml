<group name="custom,attack">

  <!-- ================================================== -->
  <!-- INITIAL ACCESS (TA0001) -->
  <!-- ================================================== -->
  
  <!-- T1190: Exploit Public-Facing Application -->
  <rule id="100100" level="12">
    <if_group>web</if_group>
    <match>SQL injection|union select|' or '1'='1</match>
    <description>SQL Injection attack detected</description>
    <mitre>
      <id>T1190</id>
      <tactic>Initial Access</tactic>
      <technique>Exploit Public-Facing Application</technique>
    </mitre>
  </rule>

  <!-- T1133: External Remote Services -->
  <rule id="100101" level="10" frequency="5" timeframe="300">
    <if_matched_sid>5710</if_matched_sid>
    <description>Multiple failed SSH login attempts - Possible brute force</description>
    <mitre>
      <id>T1133</id>
      <tactic>Initial Access</tactic>
      <technique>External Remote Services</technique>
    </mitre>
  </rule>

  <!-- T1566: Phishing -->
  <rule id="100102" level="10">
    <if_group>spam</if_group>
    <match>suspicious attachment|.exe|.scr|.js|.vbs</match>
    <description>Suspicious email attachment detected</description>
    <mitre>
      <id>T1566</id>
      <tactic>Initial Access</tactic>
      <technique>Phishing</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- EXECUTION (TA0002) -->
  <!-- ================================================== -->
  
  <!-- T1059.001: PowerShell -->
  <rule id="100200" level="12">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.scriptBlockText" type="pcre2">(?i)(invoke-expression|iex|downloadstring|downloadfile|webclient|-enc|-encodedcommand)</field>
    <description>Suspicious PowerShell execution detected</description>
    <mitre>
      <id>T1059.001</id>
      <tactic>Execution</tactic>
      <technique>Command and Scripting Interpreter: PowerShell</technique>
    </mitre>
  </rule>

  <!-- T1059.003: Windows Command Shell -->
  <rule id="100201" level="10">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(cmd\.exe.*\/c|cmd\.exe.*\/k)</field>
    <match>whoami|ipconfig|net user|net localgroup administrators</match>
    <description>Suspicious command shell execution</description>
    <mitre>
      <id>T1059.003</id>
      <tactic>Execution</tactic>
      <technique>Command and Scripting Interpreter: Windows Command Shell</technique>
    </mitre>
  </rule>

  <!-- T1204.002: Malicious File -->
  <rule id="100202" level="12">
    <if_sid>554</if_sid>
    <field name="file" type="pcre2">(?i).*\.(exe|dll|scr|bat|vbs|js)$</field>
    <match>Downloads|Temp|AppData</match>
    <description>Suspicious file execution from temp directory</description>
    <mitre>
      <id>T1204.002</id>
      <tactic>Execution</tactic>
      <technique>User Execution: Malicious File</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- PERSISTENCE (TA0003) -->
  <!-- ================================================== -->
  
  <!-- T1547.001: Registry Run Keys -->
  <rule id="100300" level="12">
    <if_sid>61612</if_sid>
    <field name="win.eventdata.targetObject" type="pcre2">(?i)SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run</field>
    <description>Modification to Run key - Persistence mechanism</description>
    <mitre>
      <id>T1547.001</id>
      <tactic>Persistence</tactic>
      <technique>Boot or Logon Autostart Execution: Registry Run Keys</technique>
    </mitre>
  </rule>

  <!-- T1543.003: Windows Service -->
  <rule id="100301" level="10">
    <if_sid>60612</if_sid>
    <field name="win.eventdata.serviceName" type="pcre2">(?!^(wuauserv|BITS|wscsvc|WinDefend)$)</field>
    <description>New service installed - Possible persistence</description>
    <mitre>
      <id>T1543.003</id>
      <tactic>Persistence</tactic>
      <technique>Create or Modify System Process: Windows Service</technique>
    </mitre>
  </rule>

  <!-- T1053.005: Scheduled Task -->
  <rule id="100302" level="10">
    <if_sid>60612</if_sid>
    <match>TaskScheduler|schtasks</match>
    <description>Scheduled task created - Possible persistence</description>
    <mitre>
      <id>T1053.005</id>
      <tactic>Persistence</tactic>
      <technique>Scheduled Task/Job: Scheduled Task</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- PRIVILEGE ESCALATION (TA0004) -->
  <!-- ================================================== -->
  
  <!-- T1068: Exploitation for Privilege Escalation -->
  <rule id="100400" level="14">
    <if_sid>60612</if_sid>
    <match>CVE-|exploit|privilege escalation</match>
    <description>Privilege escalation attempt detected</description>
    <mitre>
      <id>T1068</id>
      <tactic>Privilege Escalation</tactic>
      <technique>Exploitation for Privilege Escalation</technique>
    </mitre>
  </rule>

  <!-- T1055: Process Injection -->
  <rule id="100401" level="13">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.scriptBlockText" type="pcre2">(?i)(VirtualAlloc|WriteProcessMemory|CreateRemoteThread)</field>
    <description>Process injection detected</description>
    <mitre>
      <id>T1055</id>
      <tactic>Privilege Escalation</tactic>
      <technique>Process Injection</technique>
    </mitre>
  </rule>

  <!-- T1078: Valid Accounts - Suspicious Login -->
  <rule id="100402" level="10">
    <if_sid>5501,5503</if_sid>
    <time>20:00 - 06:00</time>
    <description>User login outside business hours</description>
    <mitre>
      <id>T1078</id>
      <tactic>Privilege Escalation</tactic>
      <technique>Valid Accounts</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- DEFENSE EVASION (TA0005) -->
  <!-- ================================================== -->
  
  <!-- T1562.001: Disable or Modify Tools -->
  <rule id="100500" level="13">
    <if_sid>61612</if_sid>
    <match>DisableAntiSpyware|DisableAntiVirus|Windows Defender</match>
    <description>Security tool disabled - Defense evasion</description>
    <mitre>
      <id>T1562.001</id>
      <tactic>Defense Evasion</tactic>
      <technique>Impair Defenses: Disable or Modify Tools</technique>
    </mitre>
  </rule>

  <!-- T1070.001: Clear Windows Event Logs -->
  <rule id="100501" level="14">
    <if_sid>61612</if_sid>
    <match>wevtutil|Clear-EventLog</match>
    <description>Event log clearing detected - Defense evasion</description>
    <mitre>
      <id>T1070.001</id>
      <tactic>Defense Evasion</tactic>
      <technique>Indicator Removal: Clear Windows Event Logs</technique>
    </mitre>
  </rule>

  <!-- T1036: Masquerading -->
  <rule id="100502" level="12">
    <if_sid>554</if_sid>
    <field name="file" type="pcre2">(?i)(svchost\.exe|lsass\.exe|csrss\.exe)</field>
    <not_field name="file" type="pcre2">(?i)C:\\Windows\\System32</not_field>
    <description>System process running from unusual location - Masquerading</description>
    <mitre>
      <id>T1036</id>
      <tactic>Defense Evasion</tactic>
      <technique>Masquerading</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- CREDENTIAL ACCESS (TA0006) -->
  <!-- ================================================== -->
  
  <!-- T1003.001: LSASS Memory -->
  <rule id="100600" level="15">
    <if_sid>61603</if_sid>
    <match>Mimikatz|sekurlsa|lsadump|procdump.*lsass</match>
    <description>Credential dumping tool detected - CRITICAL</description>
    <mitre>
      <id>T1003.001</id>
      <tactic>Credential Access</tactic>
      <technique>OS Credential Dumping: LSASS Memory</technique>
    </mitre>
  </rule>

  <!-- T1003.002: Security Account Manager -->
  <rule id="100601" level="14">
    <if_sid>61612</if_sid>
    <match>SAM|SECURITY|SYSTEM|reg save</match>
    <description>SAM database access - Credential theft</description>
    <mitre>
      <id>T1003.002</id>
      <tactic>Credential Access</tactic>
      <technique>OS Credential Dumping: Security Account Manager</technique>
    </mitre>
  </rule>

  <!-- T1110.001: Password Guessing -->
  <rule id="100602" level="10" frequency="10" timeframe="60">
    <if_matched_sid>5710</if_matched_sid>
    <same_source_ip />
    <description>Password brute force attack in progress</description>
    <mitre>
      <id>T1110.001</id>
      <tactic>Credential Access</tactic>
      <technique>Brute Force: Password Guessing</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- DISCOVERY (TA0007) -->
  <!-- ================================================== -->
  
  <!-- T1046: Network Service Scanning -->
  <rule id="100700" level="10" frequency="20" timeframe="60">
    <if_sid>4001</if_sid>
    <same_source_ip />
    <description>Port scanning detected</description>
    <mitre>
      <id>T1046</id>
      <tactic>Discovery</tactic>
      <technique>Network Service Scanning</technique>
    </mitre>
  </rule>

  <!-- T1087: Account Discovery -->
  <rule id="100701" level="8">
    <if_sid>61603</if_sid>
    <match>net user|net localgroup|Get-ADUser|Get-LocalUser</match>
    <description>Account enumeration detected</description>
    <mitre>
      <id>T1087</id>
      <tactic>Discovery</tactic>
      <technique>Account Discovery</technique>
    </mitre>
  </rule>

  <!-- T1082: System Information Discovery -->
  <rule id="100702" level="7">
    <if_sid>61603</if_sid>
    <match>systeminfo|Get-ComputerInfo|wmic</match>
    <description>System information gathering</description>
    <mitre>
      <id>T1082</id>
      <tactic>Discovery</tactic>
      <technique>System Information Discovery</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- LATERAL MOVEMENT (TA0008) -->
  <!-- ================================================== -->
  
  <!-- T1021.001: Remote Desktop Protocol -->
  <rule id="100800" level="10" frequency="3" timeframe="300">
    <if_sid>60122</if_sid>
    <description>Multiple RDP connections - Possible lateral movement</description>
    <mitre>
      <id>T1021.001</id>
      <tactic>Lateral Movement</tactic>
      <technique>Remote Services: Remote Desktop Protocol</technique>
    </mitre>
  </rule>

  <!-- T1021.002: SMB/Windows Admin Shares -->
  <rule id="100801" level="10">
    <if_sid>60612</if_sid>
    <match>\\\\.*\\C$|\\\\.*\\ADMIN$|PsExec</match>
    <description>Admin share access - Possible lateral movement</description>
    <mitre>
      <id>T1021.002</id>
      <tactic>Lateral Movement</tactic>
      <technique>Remote Services: SMB/Windows Admin Shares</technique>
    </mitre>
  </rule>

  <!-- T1550.002: Pass the Hash -->
  <rule id="100802" level="14">
    <if_sid>61612</if_sid>
    <match>NTLM authentication|NTLMv1|Pass the hash</match>
    <description>Pass-the-hash attack detected</description>
    <mitre>
      <id>T1550.002</id>
      <tactic>Lateral Movement</tactic>
      <technique>Use Alternate Authentication Material: Pass the Hash</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- COLLECTION (TA0009) -->
  <!-- ================================================== -->
  
  <!-- T1005: Data from Local System -->
  <rule id="100900" level="10">
    <if_sid>554</if_sid>
    <match>Documents|Desktop|Downloads</match>
    <field name="file" type="pcre2">(?i).*\.(zip|rar|7z|tar|gz)$</field>
    <description>Compression of user documents - Data collection</description>
    <mitre>
      <id>T1005</id>
      <tactic>Collection</tactic>
      <technique>Data from Local System</technique>
    </mitre>
  </rule>

  <!-- T1113: Screen Capture -->
  <rule id="100901" level="10">
    <if_sid>61603</if_sid>
    <match>screenshot|Get-Screenshot|BitBlt|PrintWindow</match>
    <description>Screen capture detected</description>
    <mitre>
      <id>T1113</id>
      <tactic>Collection</tactic>
      <technique>Screen Capture</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- EXFILTRATION (TA0010) -->
  <!-- ================================================== -->
  
  <!-- T1041: Exfiltration Over C2 Channel -->
  <rule id="101000" level="12">
    <if_group>firewall</if_group>
    <match>large upload|data exfiltration</match>
    <description>Possible data exfiltration detected</description>
    <mitre>
      <id>T1041</id>
      <tactic>Exfiltration</tactic>
      <technique>Exfiltration Over C2 Channel</technique>
    </mitre>
  </rule>

  <!-- T1567: Exfiltration Over Web Service -->
  <rule id="101001" level="10">
    <if_sid>61603</if_sid>
    <match>pastebin|dropbox|google drive|mega\.nz</match>
    <description>Upload to cloud service detected</description>
    <mitre>
      <id>T1567</id>
      <tactic>Exfiltration</tactic>
      <technique>Exfiltration Over Web Service</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- IMPACT (TA0040) -->
  <!-- ================================================== -->
  
  <!-- T1486: Data Encrypted for Impact (Ransomware) -->
  <rule id="104000" level="15">
    <if_sid>554</if_sid>
    <field name="file" type="pcre2">(?i).*\.(encrypted|locked|crypto|crypt)$</field>
    <description>RANSOMWARE: File encryption detected - CRITICAL</description>
    <mitre>
      <id>T1486</id>
      <tactic>Impact</tactic>
      <technique>Data Encrypted for Impact</technique>
    </mitre>
  </rule>

  <!-- T1490: Inhibit System Recovery -->
  <rule id="104001" level="15">
    <if_sid>61603</if_sid>
    <match>vssadmin delete shadows|wbadmin delete catalog|bcdedit.*recoveryenabled</match>
    <description>RANSOMWARE: Shadow copies deleted - CRITICAL</description>
    <mitre>
      <id>T1490</id>
      <tactic>Impact</tactic>
      <technique>Inhibit System Recovery</technique>
    </mitre>
  </rule>

  <!-- T1489: Service Stop -->
  <rule id="104002" level="12">
    <if_sid>60612</if_sid>
    <match>net stop|Stop-Service</match>
    <match>backup|vss|sql</match>
    <description>Critical service stopped - Ransomware indicator</description>
    <mitre>
      <id>T1489</id>
      <tactic>Impact</tactic>
      <technique>Service Stop</technique>
    </mitre>
  </rule>

  <!-- ================================================== -->
  <!-- CUSTOM THREAT HUNTING RULES -->
  <!-- ================================================== -->
  
  <!-- Living Off The Land Binaries (LOLBins) -->
  <rule id="105000" level="10">
    <if_sid>61603</if_sid>
    <match>certutil.*-decode|certutil.*-urlcache|regsvr32.*\/s|mshta.*http|rundll32.*javascript</match>
    <description>LOLBin abuse detected - Living off the land technique</description>
    <group>lolbin,evasion</group>
  </rule>

  <!-- Suspicious Parent-Child Process Relationship -->
  <rule id="105001" level="11">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">(?i)(winword\.exe|excel\.exe|outlook\.exe)</field>
    <field name="win.eventdata.image" type="pcre2">(?i)(powershell\.exe|cmd\.exe|wscript\.exe)</field>
    <description>Office application spawned shell - Macro execution</description>
    <group>macro,execution</group>
  </rule>

  <!-- Suspicious Domain Access -->
  <rule id="105002" level="10">
    <if_group>web</if_group>
    <match type="pcre2">(?i)\.(tk|ml|ga|cf|gq|top|xyz)$</match>
    <description>Access to suspicious TLD detected</description>
    <group>suspicious_domain</group>
  </rule>

  <!-- Cryptocurrency Mining -->
  <rule id="105003" level="10">
    <if_sid>61603</if_sid>
    <match>xmrig|minerd|cpuminer|stratum+tcp|cryptonight</match>
    <description>Cryptocurrency mining activity detected</description>
    <group>crypto_mining,abuse</group>
  </rule>

  <!-- ================================================== -->
  <!-- COMPLIANCE & POLICY VIOLATIONS -->
  <!-- ================================================== -->
  
  <!-- PCI-DSS: Unauthorized access to cardholder data -->
  <rule id="106000" level="12">
    <if_sid>554</if_sid>
    <match>cardholder|payment|credit_card</match>
    <description>PCI-DSS: Access to cardholder data environment</description>
    <group>pci_dss,compliance</group>
  </rule>

  <!-- GDPR: Access to personal data -->
  <rule id="106001" level="10">
    <if_sid>554</if_sid>
    <match>personal_data|customer_data|gdpr</match>
    <description>GDPR: Access to personal data detected</description>
    <group>gdpr,compliance,privacy</group>
  </rule>

  <!-- ISO 27001: Security policy violation -->
  <rule id="106002" level="10">
    <if_sid>554</if_sid>
    <match>prohibited|unauthorized|policy_violation</match>
    <description>ISO 27001: Security policy violation detected</description>
    <group>iso27001,compliance,policy</group>
  </rule>

</group>
